<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>一起看</title>
</head>
<body>

<span>RoomId：</span>
<input id="room_id" type="text" />
<button onclick="connect()">connect</button>
<br/>
<span>Local Url: </span>
<input id="video_local_url" type="text" />
<br/>
<span>Url: </span>
<input id="video_url" type="text" />
<button onclick="bindUrl()">open</button>
<br/>
<video id="video_src" controls="controls" preload="auto">
</video>
<br/>
<button onclick="doSame()">同步</button>

<script>
    var ws;
    var host = 0;
    var url;
    const video = document.getElementById("video_src")

    function connect() {
        let roomId = document.getElementById("room_id").value;
        ws = new WebSocket("ws://localhost:8080/room/" + roomId)
        ws.onopen = function () {
            console.log("open")
        }

        ws.onmessage = function (message) {
            let msg = message.data
            console.log(msg)
            if (msg === 'host') {
                host = 1
                start()
            } else if (msg.startsWith("client")) {
                host = 2
                ws.send("getVideo")
            } else if (msg.startsWith("http")) {
                url = msg;
                video.src = url
            } else if (host === 1) {

            } else {
                if (msg.startsWith("video")) {
                    url = msg.substring(5)
                    video.src = url
                } else if (msg === "play") {
                    video.play();
                } else if (msg === "pause") {
                    video.pause();
                } else if (msg.startsWith("seek")) {
                    video.currentTime = msg.substring(4)
                } else if (msg.startsWith("same")) {
                    video.currentTime = msg.substring(5)
                    if (msg.startsWith("samet")) {
                        video.play()
                    } else {
                        video.pause()
                    }
                } else if (msg.startsWith("rate")) {
                    video.playbackRate = msg.substring(4);
                }
            }
        }
    }

    function bindUrl() {
        let videoUrl = document.getElementById("video_url").value;
        let videoLocalUrl = document.getElementById("video_local_url").value;
        if (host === 1) {
            ws.send("video" + videoUrl)
            if (videoLocalUrl === "") {
                videoLocalUrl = videoUrl
            }
            video.src = videoLocalUrl
        }
    }

    var isPlay = false

    function start() {
        video.onplay = () => {
            if (host === 1) {
                ws.send("play")
                isPlay = true
            }
        }
        video.onpause = () => {
            if (host === 1) {
                ws.send("pause")
                isPlay = false
            }
        }

        video.onseeked = () => {
            if (host === 1) {
                ws.send("seek" + video.currentTime)
            }
        }
        video.onratechange = () => {
            if (host === 1) {
                ws.send("rate" + video.playbackRate)
            }
        }
    }

    function doSame() {
        if (host === 1) {
            ws.send("same" + (isPlay ? 't' : 'f') + video.currentTime);
        }
    }
</script>
</body>
</html>
